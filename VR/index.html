<!DOCTYPE html>
<html>
<head>
    <title>Three.js VR Movement Example</title>
    <style>
        body { margin: 0; }
        canvas { display: block; }
    </style>
</head>
<body>
  <script type="importmap">
    {
        "imports": {
            "three": "../jsm/build/three.module.js"
        }
    }
</script>

<script type="module">
    import * as THREE from 'three';
    import { VRButton } from '../jsm/webxr/VRButton.js';

    const texture = new THREE.TextureLoader().load( '../Imagenes/textures/crate.gif' );
    const suelo = new THREE.TextureLoader().load( '../Imagenes/textures/sueloblanco.jpg' );
    const muro = new THREE.TextureLoader().load( '../Imagenes/textures/extura.jpg' );
    const pared = new THREE.TextureLoader().load( '../Imagenes/parametros/secuencia.png' );

    var wall1, sphere, box, box1, box2;

    let camera, scene, renderer;
    let controller1, controller2;
    let group;

    init();
    animate();

    function init() {
        const container = document.createElement('div');
        document.body.appendChild(container);

        scene = new THREE.Scene();
        scene.background = new THREE.Color(0x5E7E9F);

        camera = new THREE.PerspectiveCamera(50, window.innerWidth / window.innerHeight, 0.1, 10);
        camera.position.set(0, 1.6, 3);

        const light = new THREE.HemisphereLight(0xffffff, 0x444444);
        light.position.set(1, 1, 1);
        scene.add(light);

        renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.xr.enabled = true;
        container.appendChild(renderer.domElement);

        document.body.appendChild(VRButton.createButton(renderer));

        group = new THREE.Group();
        scene.add(group);

        group.add(camera);

        // Controllers
        controller1 = renderer.xr.getController(0);
        scene.add(controller1);

        controller2 = renderer.xr.getController(1);
        scene.add(controller2);

        controller1.addEventListener('selectstart', onSelectStartRight);
        controller2.addEventListener('selectstart', onSelectStartLeft);

        // OBJETOS Escena
        var floor = getFloor();
        floor.rotateX( Math.PI / -2 );
        floor.name = "suelo";

        // Pared
        wall1 = getWall(pared);
        wall1.position.set( 0, 12.5, -45);

        var side1 = getSide();
        side1.position.set (50, 12.5, 0);
        side1.rotateX (Math.PI / 2);

        var side2 = getSide();
        side2.position.set (-50, 12.5, 0);
        side2.rotateX (Math.PI / 2);

        var side3 = getSide();
        side3.position.set (0, 12.5, -48.5);
        side3.rotateY (Math.PI / 2);
        side3.rotateX (Math.PI / 2);
        
        box = getBox();
        box.position.set (0, 2, -15);
        box.rotateX (Math.PI / 2);
        box.name = "proxy";
        var colorOriginal = box.material.color.getHex();

        box1 = getBox();
        box1.position.set (-15, 2, 15);
        box1.rotateX (Math.PI / 2);
        box1.name = "UA1";

        box2 = getBox();
        box2.position.set (15, 2, 15);
        box2.rotateX (Math.PI / 2);
        box2.name = "UA2";

        sphere = getSphere();
        sphere.position.set (-15, 2, 15);
        sphere.rotateX (Math.PI/2);
        sphere.rotateY (Math.PI/-2);
        sphere.name = "sphere";

        scene.add(side1);
        scene.add(side2);
        scene.add(side3);
        scene.add(wall1);
        scene.add(floor);
        scene.add(box);
        scene.add(box1);
        scene.add(box2);
        scene.add(sphere);

        // Eventos
        window.addEventListener('resize', onWindowResize, false);
    }

    function onSelectStartRight() {
        console.log("Pulso Boton Derecho");
        moveForward(0.5); // Movimiento
    }

    function onSelectStartLeft() {
        console.log("Pulso Boton Izquierdo");
        moveForward(-0.5); // Movimiento
    }

    function moveForward(distance) {
        const direction = new THREE.Vector3();
        group.getWorldDirection(direction);
        direction.multiplyScalar(distance);
        group.position.add(direction);
        //group.position.z += distance;
        console.log("X:" + group.position.x);
        console.log("Y:" + group.position.y);
        console.log("Z:" + group.position.z);
    }

    function onWindowResize() {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
    }

    function animate() {
        renderer.setAnimationLoop(render);
    }

    function render() {
        renderer.render(scene, camera);
    }

    function getFloor() {
        var geometry = new THREE.PlaneGeometry(100, 100);
        var material = new THREE.MeshBasicMaterial( { map: suelo });
        material.map.wrapS = THREE.RepeatWrapping;
        material.map.wrapT = THREE.RepeatWrapping;
        material.map.anisotropy = 4;
        material.map.repeat.set( 4, 4);
        var mesh = new THREE.Mesh(geometry, material);
        return mesh;
    }

    function getWall(nueva) {
        var geometry = new THREE.PlaneGeometry(20, 20);
        var material = new THREE.MeshBasicMaterial( { map: nueva });
        var mesh = new THREE.Mesh(geometry, material);
        return mesh;
    }

    function getBox() {
        var geometry = new THREE.BoxGeometry(1, 1, 1);
        var material = new THREE.MeshBasicMaterial( { map: texture } );
        var mesh = new THREE.Mesh(geometry, material);
        mesh.position.z = 2;
        return mesh;
    }

    function getSide() {
        var geometry = new THREE.BoxGeometry(3, 100, 25);
        var material = new THREE.MeshBasicMaterial( { map: muro } );
        material.map.wrapS = THREE.RepeatWrapping;
        material.map.wrapT = THREE.RepeatWrapping;
        material.map.anisotropy = 4;
        material.map.repeat.set( 4, 8);

        var mesh = new THREE.Mesh(geometry, material);
        mesh.position.z = 2;
        return mesh;
    }

    function getSphere() {
        var geometry = new THREE.SphereGeometry(0.5, 32, 20);
        var material = new THREE.MeshBasicMaterial({color: "red"}); 
        var mesh = new THREE.Mesh(geometry, material);
        mesh.position.z = 0.5;
        mesh.castShadow = true;
        mesh.name = "sphere";
        return mesh;
    }
</script>
</body>
</html>
